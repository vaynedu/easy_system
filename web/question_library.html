<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>题库管理 - 简易多题型自动出题系统</title>
    <style>
        .container { width: 90%; margin: 20px auto; }
        .module { margin: 30px 0; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
        button {
            padding: 8px 15px; margin: 5px;
            background-color: #4285F4; color: white; border: none; border-radius: 4px; cursor: pointer;
        }
        button:hover { background-color: #3367D6; }
        select, input {
            padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f5f5f5; }
        .pagination { margin-top: 20px; text-align: center; }
        .pagination button { margin: 0 5px; }
        .edit-btn { background-color: #28a745; }
        .delete-btn { background-color: #dc3545; }
        .tag-label {
            display: inline-block; padding: 2px 8px; margin: 2px;
            background-color: #6c757d; color: white; border-radius: 4px; font-size: 12px;
        }
        .second-tag-label {
            display: inline-block; padding: 2px 8px; margin: 2px;
            background-color: #17a2b8; color: white; border-radius: 4px; font-size: 12px;
        }
        .search-box { margin: 10px 0; }
        /* 模态框核心样式优化：新增滚动+最大高度 */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);
            overflow-y: auto; /* 页面级滚动兜底 */
        }
        .modal-content {
            background-color: white; margin: 3% auto; padding: 25px; border-radius: 8px;
            width: 80%; max-width: 800px;
            max-height: 90vh; /* 关键：限制最大高度为视口90% */
            overflow-y: auto; /* 关键：内容超出时垂直滚动 */
            box-sizing: border-box; /* 内边距计入宽度/高度 */
        }
        .close {
            float: right; font-size: 28px; font-weight: bold; cursor: pointer;
            margin: -10px -10px 10px 0; /* 调整关闭按钮位置 */
        }
        .close:hover { color: #dc3545; }
        .type-choice {
            background-color: #4285F4;
            color: white;
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: bold;
            display: inline-block;
            text-align: center;
        }
        .type-fill {
            background-color: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: bold;
            display: inline-block;
            text-align: center;
        }
        .type-essay {
            background-color: #6c757d;
            color: white;
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: bold;
            display: inline-block;
            text-align: center;
        }
        .type-unknown {
            background-color: #dc3545;
            color: white;
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: bold;
            display: inline-block;
            text-align: center;
        }
        .tag-primary {
            background-color: #6c757d;
            color: white;
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: bold;
            display: inline-block;
            text-align: center;
            margin-right: 4px;
        }
        .tag-secondary {
            background-color: #17a2b8;
            color: white;
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: bold;
            display: inline-block;
            text-align: center;
        }
        .tag-none {
            background-color: #6c757d;
            color: white;
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: bold;
            display: inline-block;
            text-align: center;
        }
        /* 编辑表单统一样式 */
        .edit-form-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 15px;
        }
        .edit-form-label {
            width: 100px;
            font-weight: bold;
            color: #333;
            flex-shrink: 0; /* 标签宽度不收缩 */
            padding-top: 4px; /* 对齐输入框基线 */
        }
        .edit-form-control {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .edit-form-row-category {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .edit-form-row-category > div {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .edit-form-btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee; /* 分隔按钮区 */
        }
        .edit-form-btn-group button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: white;
            margin: 0; /* 重置默认margin */
        }
    </style>
</head>
<body>
<div class="container">
    <h1>题库管理</h1>

    <!-- 筛选和搜索模块 -->
    <div class="module">
        <h2>题目筛选</h2>
        <select id="primaryTagFilter" onchange="loadSecondaryTagFilter()">
            <option value="">全部一级分类</option>
            <!-- 动态加载 -->
        </select>
        <select id="secondaryTagFilter">
            <option value="">全部二级分类</option>
            <!-- 联动加载 -->
        </select>
        <select id="questionTypeFilter">
            <option value="">全部题型</option>
            <option value="0">选择题</option>
            <option value="1">填空题</option>
            <option value="2">问答题</option>
        </select>
        <input type="text" id="searchKeyword" placeholder="关键词搜索（题干、答案等）" style="width: 300px;">
        <button onclick="searchQuestions()">搜索</button>
        <button onclick="resetFilter()">重置</button>
        <button onclick="exportAllQuestions()">导出全部</button>
        <button onclick="exportFilteredQuestions()">导出筛选结果</button>
    </div>

    <!-- 在题目列表模块中添加批量操作区域 -->
    <div class="module">
        <h2>题目列表</h2>
        <div style="margin-bottom: 15px;">
            <label>
                <input type="checkbox" id="selectAll" onclick="toggleSelectAll()"> 全选
            </label>
            <button onclick="exportSelectedQuestions()" style="margin-left: 20px;">导出选中题目</button>
        </div>
        <div id="questionListContainer">
            <table id="questionTable">
                <thead>
                <tr>
                    <th>选择</th>
                    <th>ID</th>
                    <th>题型</th>
                    <th>题干</th>
                    <th>分类</th>
                    <th>答案</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="questionTableBody">
                <!-- 动态加载 -->
                </tbody>
            </table>
            <div class="pagination" id="pagination">
                <!-- 分页按钮 -->
            </div>
        </div>
    </div>
</div>

<!-- 编辑模态框（优化滚动+布局） -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2 style="margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid #eee;">编辑题目</h2>
        <form id="editForm">
            <input type="hidden" id="editId">

            <!-- 表单容器（滚动核心） -->
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <!-- 题型 -->
                <div class="edit-form-row">
                    <label class="edit-form-label">题型</label>
                    <select id="editQuestionType" class="edit-form-control">
                        <option value="0">选择题</option>
                        <option value="1">填空题</option>
                        <option value="2">问答题</option>
                    </select>
                </div>

                <!-- 题干 -->
                <div class="edit-form-row">
                    <label class="edit-form-label">题干</label>
                    <textarea id="editQuestionTitle" placeholder="题干" rows="4" class="edit-form-control"></textarea>
                </div>

                <!-- 选项组（仅在选择题时显示） -->
                <div id="editOptionGroup" style="display: none; flex-direction: column; gap: 15px;">
                    <div class="edit-form-row">
                        <label class="edit-form-label">选项A</label>
                        <input type="text" id="editOptionA" placeholder="选项A" class="edit-form-control">
                    </div>
                    <div class="edit-form-row">
                        <label class="edit-form-label">选项B</label>
                        <input type="text" id="editOptionB" placeholder="选项B" class="edit-form-control">
                    </div>
                    <div class="edit-form-row">
                        <label class="edit-form-label">选项C</label>
                        <input type="text" id="editOptionC" placeholder="选项C" class="edit-form-control">
                    </div>
                    <div class="edit-form-row">
                        <label class="edit-form-label">选项D</label>
                        <input type="text" id="editOptionD" placeholder="选项D" class="edit-form-control">
                    </div>
                </div>

                <!-- 正确答案 -->
                <div class="edit-form-row">
                    <label class="edit-form-label">正确答案</label>
                    <textarea id="editCorrectAnswer" placeholder="正确答案（A/B/C/D）" rows="10" class="edit-form-control"></textarea>
                </div>


                <!-- 答案解析 -->
                <div class="edit-form-row">
                    <label class="edit-form-label">答案解析</label>
                    <textarea id="editAnswerAnalysis" placeholder="答案解析" rows="4" class="edit-form-control"></textarea>
                </div>

                <!-- 题目备注 -->
                <div class="edit-form-row">
                    <label class="edit-form-label">题目备注</label>
                    <textarea id="editQuestionRemark" placeholder="题目备注" rows="4" class="edit-form-control"></textarea>
                </div>

                <!-- 分类选择 -->
                <div class="edit-form-row-category">
                    <div>
                        <label class="edit-form-label">一级分类</label>
                        <select id="editTag" class="edit-form-control">
                            <option value="">选择一级分类</option>
                        </select>
                    </div>
                    <div>
                        <label class="edit-form-label">二级分类</label>
                        <select id="editSecondTag" class="edit-form-control">
                            <option value="">选择二级分类</option>
                        </select>
                    </div>
                </div>

                <!-- 操作按钮（固定视觉底部） -->
                <div class="edit-form-btn-group">
                    <button type="button" onclick="saveQuestion()" style="background-color: #4285F4;">保存</button>
                    <button type="button" onclick="closeEditModal()" style="background-color: #6c757d;">取消</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    const baseUrl = "http://127.0.0.1:8080/api";
    let tagTreeData = [];
    let currentPage = 1;
    const pageSize = 10;

    window.onload = function() {
        loadPrimaryTagFilter();
        loadTagOptions();
        loadQuestions();

        // 为全选复选框添加事件监听器
        document.getElementById('selectAll').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('input[name="selectQuestion"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    };

    // 加载一级分类筛选
    function loadPrimaryTagFilter() {
        const primaryTagSelect = document.getElementById("primaryTagFilter");
        primaryTagSelect.innerHTML = '<option value="">全部一级分类</option>';

        fetch(`${baseUrl}/tag/tree`, { method: "GET" })
            .then(res => res.json())
            .then(res => {
                if (res.code === 200) {
                    tagTreeData = res.data;
                    tagTreeData.forEach(primaryTag => {
                        const option = document.createElement("option");
                        option.value = primaryTag.name;
                        option.textContent = primaryTag.name;
                        primaryTagSelect.appendChild(option);
                    });
                }
            });
    }

    // 联动加载二级分类筛选
    function loadSecondaryTagFilter() {
        const primaryTagValue = document.getElementById("primaryTagFilter").value;
        const secondaryTagSelect = document.getElementById("secondaryTagFilter");
        secondaryTagSelect.innerHTML = '<option value="">全部二级分类</option>';

        if (!primaryTagValue) return;

        const targetPrimaryTag = tagTreeData.find(item => item.name === primaryTagValue);
        if (targetPrimaryTag && targetPrimaryTag.second_tag) {
            targetPrimaryTag.second_tag.forEach(secondaryTag => {
                const option = document.createElement("option");
                option.value = secondaryTag;
                option.textContent = secondaryTag;
                secondaryTagSelect.appendChild(option);
            });
        }
    }

    // 编辑函数 修改 loadTagOptions 函数，确保它能正确加载分类数据
    function loadTagOptions() {
        const editTagSelect = document.getElementById("editTag");
        editTagSelect.innerHTML = '<option value="">选择一级分类</option>';

        // 检查 tagTreeData 是否已加载
        if (tagTreeData.length === 0) {
            // 如果未加载，先获取分类数据
            fetch(`${baseUrl}/tag/tree`, { method: "GET" })
                .then(res => res.json())
                .then(res => {
                    if (res.code === 200) {
                        tagTreeData = res.data;
                        // 重新加载选项
                        loadTagOptions();
                    }
                });
            return;
        }

        // 正常加载一级分类
        tagTreeData.forEach(primaryTag => {
            const option = document.createElement("option");
            option.value = primaryTag.name;
            option.textContent = primaryTag.name;
            editTagSelect.appendChild(option);
        });

        // 监听一级分类变化
        editTagSelect.onchange = function() {
            const editSecondTagSelect = document.getElementById("editSecondTag");
            editSecondTagSelect.innerHTML = '<option value="">选择二级分类</option>';

            if (this.value) {
                const targetPrimaryTag = tagTreeData.find(item => item.name === this.value);
                if (targetPrimaryTag && targetPrimaryTag.second_tag) {
                    targetPrimaryTag.second_tag.forEach(secondaryTag => {
                        const option = document.createElement("option");
                        option.value = secondaryTag;
                        option.textContent = secondaryTag;
                        editSecondTagSelect.appendChild(option);
                    });
                }
            }
        };
    }

    // 搜索题目
    function searchQuestions() {
        currentPage = 1;
        loadQuestions();
    }

    // 重置筛选
    function resetFilter() {
        document.getElementById("primaryTagFilter").value = "";
        document.getElementById("secondaryTagFilter").value = "";
        document.getElementById("questionTypeFilter").value = "";
        document.getElementById("searchKeyword").value = "";
        loadSecondaryTagFilter(); // 重置二级分类
        currentPage = 1;
        loadQuestions();
    }

    // 加载题目列表
    function loadQuestions() {
        const primaryTag = document.getElementById("primaryTagFilter").value;
        const secondaryTag = document.getElementById("secondaryTagFilter").value;
        const questionType = document.getElementById("questionTypeFilter").value;
        const keyword = document.getElementById("searchKeyword").value;

        let params = new URLSearchParams({
            page: currentPage,
            size: pageSize
        });

        if (primaryTag) params.append('tag', primaryTag);
        if (secondaryTag) params.append('second_tag', secondaryTag);
        if (questionType) params.append('type', questionType);
        if (keyword) params.append('keyword', keyword);

        fetch(`${baseUrl}/questions?${params.toString()}`, { method: "GET" })
            .then(res => res.json())
            .then(res => {
                if (res.code === 200) {
                    renderQuestionList(res.data.questions);
                    renderPagination(res.data.total, res.data.page, res.data.size);
                } else {
                    alert("加载题目失败：" + res.msg);
                }
            })
            .catch(err => {
                alert("加载题目失败：" + err.message);
            });
    }

    // 渲染题目列表
    function renderQuestionListV1(questions) {
        const tbody = document.getElementById("questionTableBody");
        tbody.innerHTML = "";

        questions.forEach(q => {
            const row = document.createElement("tr");

            let typeText = "";
            let typeClass = "";
            switch (q.question_type) {
                case 0:
                    typeText = "选择题";
                    typeClass = "type-choice";
                    break;
                case 1:
                    typeText = "填空题";
                    typeClass = "type-fill";
                    break;
                case 2:
                    typeText = "问答题";
                    typeClass = "type-essay";
                    break;
                default:
                    typeText = "未知题型";
                    typeClass = "type-unknown";
            }

            let tagHtml = "";
            if (q.tag || q.second_tag) {
                if (q.tag) tagHtml += `<span class="tag-primary">${q.tag}</span>`;
                if (q.second_tag) tagHtml += `<span class="tag-secondary">${q.second_tag}</span>`;
            } else {
                tagHtml = "<span class='tag-none'>无</span>";
            }

            // 根据题型调整答案显示
            let answerText = q.correct_answer;
            if (q.question_type === 0) { // 选择题
                let optionText = "";
                switch (q.correct_answer) {
                    case "A":
                        optionText = q.option_a || "";
                        break;
                    case "B":
                        optionText = q.option_b || "";
                        break;
                    case "C":
                        optionText = q.option_c || "";
                        break;
                    case "D":
                        optionText = q.option_d || "";
                        break;
                    default:
                        optionText = q.correct_answer;
                }
                answerText = `${q.correct_answer} - ${optionText}`;
            }

            row.innerHTML = `
            <td>${q.id}</td>
            <td><span class="${typeClass}">${typeText}</span></td>
            <td style="max-width: 300px; word-wrap: break-word;">${q.question_title}</td>
            <td>${tagHtml}</td>
            <td style="max-width: 300px; word-wrap: break-word;">${answerText}</td>
            <td>
                <button class="edit-btn" onclick="editQuestion(${q.id})">编辑</button>
                <button class="delete-btn" onclick="deleteQuestion(${q.id})">删除</button>
            </td>
        `;
            tbody.appendChild(row);
        });
    }

    // 渲染分页
    function renderPagination(total, currentPage, pageSize) {
        const totalPages = Math.ceil(total / pageSize);
        const pagination = document.getElementById("pagination");

        let html = '';
        if (currentPage > 1) {
            html += `<button onclick="goToPage(${currentPage - 1})">上一页</button>`;
        }

        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage) {
                html += `<button style="background-color: #007bff; color: white;">${i}</button>`;
            } else {
                html += `<button onclick="goToPage(${i})">${i}</button>`;
            }
        }

        if (currentPage < totalPages) {
            html += `<button onclick="goToPage(${currentPage + 1})">下一页</button>`;
        }

        pagination.innerHTML = html;
    }

    // 跳转到指定页
    function goToPage(page) {
        currentPage = page;
        loadQuestions();
    }

    // 编辑题目
    function editQuestion(id) {
        fetch(`${baseUrl}/question/${id}`, { method: "GET" })
            .then(res => res.json())
            .then(res => {
                if (res.code === 200) {
                    const q = res.data;
                    document.getElementById("editId").value = q.id;
                    document.getElementById("editQuestionType").value = q.question_type;
                    document.getElementById("editQuestionTitle").value = q.question_title;
                    document.getElementById("editOptionA").value = q.option_a || "";
                    document.getElementById("editOptionB").value = q.option_b || "";
                    document.getElementById("editOptionC").value = q.option_c || "";
                    document.getElementById("editOptionD").value = q.option_d || "";
                    document.getElementById("editCorrectAnswer").value = q.correct_answer;
                    document.getElementById("editAnswerAnalysis").value = q.answer_analysis || "";
                    document.getElementById("editQuestionRemark").value = q.question_remark || "";

                    // 设置分类前确保分类数据已加载
                    if (tagTreeData.length === 0) {
                        fetch(`${baseUrl}/tag/tree`, { method: "GET" })
                            .then(res => res.json())
                            .then(res => {
                                if (res.code === 200) {
                                    tagTreeData = res.data;
                                    setCategoryValues(q);
                                }
                            });
                    } else {
                        setCategoryValues(q);
                    }

                    toggleOptionGroup(q.question_type);
                    document.getElementById("editModal").style.display = "block";
                } else {
                    alert("获取题目信息失败：" + res.msg);
                }
            });
    }

    // 新增辅助函数设置分类值
    function setCategoryValues(question) {
        // 设置一级分类
        document.getElementById("editTag").value = question.tag || "";
        // 触发二级分类加载
        document.getElementById("editTag").onchange();
        setTimeout(() => {
            document.getElementById("editSecondTag").value = question.second_tag || "";
        }, 100);
    }

    // 题型联动选项显示
    function toggleOptionGroup(type) {
        const optionGroup = document.getElementById("editOptionGroup");
        if (type === 0) {
            optionGroup.style.display = "flex";
            document.getElementById("editCorrectAnswer").placeholder = "正确答案（A/B/C/D）";
        } else {
            optionGroup.style.display = "none";
            document.getElementById("editCorrectAnswer").placeholder = "正确答案";
        }
    }

    // 保存题目
    function saveQuestion() {
        const id = document.getElementById("editId").value;
        const data = {
            id: parseInt(id),
            question_type: parseInt(document.getElementById("editQuestionType").value),
            question_title: document.getElementById("editQuestionTitle").value.trim(),
            option_a: document.getElementById("editOptionA").value.trim(),
            option_b: document.getElementById("editOptionB").value.trim(),
            option_c: document.getElementById("editOptionC").value.trim(),
            option_d: document.getElementById("editOptionD").value.trim(),
            correct_answer: document.getElementById("editCorrectAnswer").value.trim(),
            answer_analysis: document.getElementById("editAnswerAnalysis").value.trim(),
            question_remark: document.getElementById("editQuestionRemark").value.trim(),
            tag: document.getElementById("editTag").value.trim(),
            second_tag: document.getElementById("editSecondTag").value.trim()
        };

        fetch(`${baseUrl}/question/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(res => {
                if (res.code === 200) {
                    alert("保存成功！");
                    closeEditModal();
                    loadQuestions(); // 重新加载列表
                } else {
                    alert("保存失败：" + res.msg);
                }
            })
            .catch(err => {
                alert("保存失败：" + err.message);
            });
    }

    // 删除题目
    function deleteQuestion(id) {
        if (confirm("确定要删除这道题目吗？")) {
            fetch(`${baseUrl}/question/${id}`, {
                method: "DELETE"
            })
                .then(res => res.json())
                .then(res => {
                    if (res.code === 200) {
                        alert("删除成功！");
                        loadQuestions(); // 重新加载列表
                    } else {
                        alert("删除失败：" + res.msg);
                    }
                })
                .catch(err => {
                    alert("删除失败：" + err.message);
                });
        }
    }

    // 关闭编辑模态框
    function closeEditModal() {
        document.getElementById("editModal").style.display = "none";
    }


    // 导出全部题目
    function exportAllQuestions() {
        const data = {
            export_all: true
        };

        fetch(`${baseUrl}/exportExcelQuestion`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    return response.json().then(err => {
                        alert("导出失败：" + err.msg);
                        throw new Error("导出失败");
                    });
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'all_questions.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(err => {
                console.error('导出失败:', err);
            });
    }

    // 导出筛选结果
    function exportFilteredQuestions() {
        const primaryTag = document.getElementById("primaryTagFilter").value;
        const secondaryTag = document.getElementById("secondaryTagFilter").value;
        const questionType = document.getElementById("questionTypeFilter").value;
        const keyword = document.getElementById("searchKeyword").value;

        const data = {
            tag: primaryTag,
            second_tag: secondaryTag,
            type: questionType,
            keyword: keyword
        };

        fetch(`${baseUrl}/exportExcelQuestion`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    return response.json().then(err => {
                        alert("导出失败：" + err.msg);
                        throw new Error("导出失败");
                    });
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'filtered_questions.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(err => {
                console.error('导出失败:', err);
            });
    }

    // 导出选中题目
    function exportSelectedQuestions() {
        const selectedCheckboxes = document.querySelectorAll('input[name="selectQuestion"]:checked');
        if (selectedCheckboxes.length === 0) {
            alert("请先选择要导出的题目");
            return;
        }

        const ids = [];
        selectedCheckboxes.forEach(checkbox => {
            ids.push(parseInt(checkbox.value));
        });

        const data = {
            ids: ids
        };

        fetch(`${baseUrl}/exportExcelQuestion`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    return response.json().then(err => {
                        alert("导出失败：" + err.msg);
                        throw new Error("导出失败");
                    });
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'selected_questions.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(err => {
                console.error('导出失败:', err);
            });
    }

    // 全选/取消全选功能
    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('input[name="selectQuestion"]');

        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
    }

    // 在renderQuestionList函数中添加复选框
    function renderQuestionList(questions) {
        const tbody = document.getElementById("questionTableBody");
        tbody.innerHTML = "";

        questions.forEach(q => {
            const row = document.createElement("tr");

            let typeText = "";
            let typeClass = "";
            switch (q.question_type) {
                case 0:
                    typeText = "选择题";
                    typeClass = "type-choice";
                    break;
                case 1:
                    typeText = "填空题";
                    typeClass = "type-fill";
                    break;
                case 2:
                    typeText = "问答题";
                    typeClass = "type-essay";
                    break;
                default:
                    typeText = "未知题型";
                    typeClass = "type-unknown";
            }

            let tagHtml = "";
            if (q.tag || q.second_tag) {
                if (q.tag) tagHtml += `<span class="tag-primary">${q.tag}</span>`;
                if (q.second_tag) tagHtml += `<span class="tag-secondary">${q.second_tag}</span>`;
            } else {
                tagHtml = "<span class='tag-none'>无</span>";
            }

            // 根据题型调整答案显示
            let answerText = q.correct_answer;
            if (q.question_type === 0) { // 选择题
                let optionText = "";
                switch (q.correct_answer) {
                    case "A":
                        optionText = q.option_a || "";
                        break;
                    case "B":
                        optionText = q.option_b || "";
                        break;
                    case "C":
                        optionText = q.option_c || "";
                        break;
                    case "D":
                        optionText = q.option_d || "";
                        break;
                    default:
                        optionText = q.correct_answer;
                }
                answerText = `${q.correct_answer} - ${optionText}`;
            }

            row.innerHTML = `
        <td><input type="checkbox" name="selectQuestion" value="${q.id}"></td>
        <td>${q.id}</td>
        <td><span class="${typeClass}">${typeText}</span></td>
        <td style="max-width: 300px; word-wrap: break-word;">${q.question_title}</td>
        <td>${tagHtml}</td>
        <td style="max-width: 300px; word-wrap: break-word;">${answerText}</td>
        <td>
            <button class="edit-btn" onclick="editQuestion(${q.id})">编辑</button>
            <button class="delete-btn" onclick="deleteQuestion(${q.id})">删除</button>
        </td>
    `;
            tbody.appendChild(row);
        });

        // 为所有复选框添加事件监听器
        document.querySelectorAll('input[name="selectQuestion"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectAllCheckbox();
            });
        });
    }

    // 更新全选复选框状态
    function updateSelectAllCheckbox() {
        const checkboxes = document.querySelectorAll('input[name="selectQuestion"]');
        const selectAllCheckbox = document.getElementById('selectAll');

        const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(checkbox => checkbox.checked);
        const noneChecked = Array.from(checkboxes).every(checkbox => !checkbox.checked);

        selectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = !allChecked && !noneChecked;
    }





    // 题型变化时联动选项显示
    document.getElementById("editQuestionType").onchange = function() {
        toggleOptionGroup(this.value);
    };

    // 点击模态框外部关闭
    window.onclick = function(event) {
        const modal = document.getElementById("editModal");
        if (event.target === modal) {
            closeEditModal();
        }
    };
</script>
</body>
</html>