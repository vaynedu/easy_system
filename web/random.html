<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>随机抽题练习 - 简易多题型自动出题系统</title>
    <style>
        .container { width: 80%; margin: 20px auto; }
        .module { margin: 30px 0; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
        button {
            display: block; margin: 10px 0; padding: 10px 20px;
            background-color: #4285F4; color: white; border: none; border-radius: 4px; cursor: pointer;
            font-size: 16px;
        }
        button:hover { background-color: #3367D6; }
        #questionList { margin-top: 20px; line-height: 1.8; }
        .question-item {
            margin: 20px 0; padding: 15px; border: 1px solid #eee; border-radius: 6px;
            background-color: #f9f9f9;
        }
        .question-type {
            display: inline-block; padding: 2px 8px; margin-right: 10px;
            background-color: #4285F4; color: white; border-radius: 4px; font-size: 12px;
        }
        /* 新增分类标签样式 */
        .tag-label {
            display: inline-block; padding: 2px 8px; margin-right: 8px;
            background-color: #6c757d; color: white; border-radius: 4px; font-size: 12px;
        }
        .second-tag-label {
            display: inline-block; padding: 2px 8px; margin-right: 10px;
            background-color: #17a2b8; color: white; border-radius: 4px; font-size: 12px;
        }
        .correct-answer { color: #28a745; font-weight: bold; }
        .analysis { color: #666; margin: 5px 0; }
        .remark { color: #999; font-style: italic; font-size: 14px; }
    h1 { color: #333; border-bottom: 2px solid #4285F4; padding-bottom: 10px; }
    /* 收藏星形图标样式 */
    .favorite-star {
        cursor: pointer;
        font-size: 20px;
        color: #ccc;
        margin-left: 10px;
        transition: color 0.3s;
    }
    .favorite-star:hover {
        color: #ffc107;
    }
    .favorite-star.favorited {
        color: #ffc107;
    }
    /* 分类选择框样式 */
        select {
            display: block; margin: 10px 0; padding: 8px; width: 50%; box-sizing: border-box;
            border: 1px solid #ddd; border-radius: 4px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>随机抽题练习（选择/填空/问答）</h1>

    <!-- 随机抽题模块（新增分类筛选） -->
    <div class="module">
        <h2>随机抽取10道题</h2>
        <!-- 新增：一级分类筛选 -->
        <select id="primaryTag" onchange="loadSecondaryTags()">
            <option value="">请选择一级分类（可选）</option>
            <!-- 动态加载一级分类 -->
        </select>
        <!-- 新增：二级分类筛选 -->
        <select id="secondaryTag">
            <option value="">请先选择一级分类</option>
            <!-- 联动加载二级分类 -->
        </select>
        <button onclick="getRandom10Questions()">点击获取随机题目</button>
        <div id="questionList"></div>
    </div>
</div>

<script>
    const baseUrl = "http://127.0.0.1:8080/api";
    let tagTreeData = []; // 缓存分类树数据

    // 页面加载初始化
    window.onload = function() {
        loadPrimaryTags();
    }

    // 加载一级分类数据
    function loadPrimaryTags() {
        const primaryTagSelect = document.getElementById("primaryTag");
        primaryTagSelect.innerHTML = '<option value="">请选择一级分类（可选）</option>';

        fetch(`${baseUrl}/tag/tree`, { method: "GET" })
            .then(res => res.json())
            .then(res => {
                if (res.code === 200) {
                    tagTreeData = res.data;
                    // 渲染一级分类选项
                    tagTreeData.forEach(primaryTag => {
                        const option = document.createElement("option");
                        option.value = primaryTag.name;
                        option.textContent = primaryTag.name;
                        primaryTagSelect.appendChild(option);
                    });
                } else {
                    console.error("加载分类数据失败：", res.msg);
                    const list = document.getElementById("questionList");
                    list.style.color = "orange";
                    list.innerText = "分类数据加载失败，将获取全部题目！";
                }
            })
            .catch(err => {
                console.error("加载分类异常：", err);
                const list = document.getElementById("questionList");
                list.style.color = "orange";
                list.innerText = "分类数据加载异常，将获取全部题目！";
            });
    }

    // 联动加载二级分类数据
    function loadSecondaryTags() {
        const primaryTagValue = document.getElementById("primaryTag").value;
        const secondaryTagSelect = document.getElementById("secondaryTag");
        secondaryTagSelect.innerHTML = '';

        if (!primaryTagValue) {
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "请先选择一级分类";
            secondaryTagSelect.appendChild(defaultOption);
            return;
        }

        const targetPrimaryTag = tagTreeData.find(item => item.name === primaryTagValue);
        if (targetPrimaryTag && targetPrimaryTag.second_tag && targetPrimaryTag.second_tag.length > 0) {
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "请选择二级分类（可选）";
            secondaryTagSelect.appendChild(defaultOption);
            // 渲染二级分类选项
            targetPrimaryTag.second_tag.forEach(secondaryTag => {
                const option = document.createElement("option");
                option.value = secondaryTag;
                option.textContent = secondaryTag;
                secondaryTagSelect.appendChild(option);
            });
        } else {
            const noOption = document.createElement("option");
            noOption.value = "";
            noOption.textContent = "该一级分类无二级分类";
            secondaryTagSelect.appendChild(noOption);
        }
    }

    // 随机获取10道题（新增分类筛选参数）
    function getRandom10Questions() {
        const list = document.getElementById("questionList");
        list.innerHTML = '<p style="color: #666;">正在获取题目，请稍候...</p>';

        // 获取筛选条件
        const primaryTag = document.getElementById("primaryTag").value.trim();
        const secondaryTag = document.getElementById("secondaryTag").value.trim();

        // 构造查询参数
        let queryParams = [];
        if (primaryTag) queryParams.push(`tag=${encodeURIComponent(primaryTag)}`);
        if (secondaryTag) queryParams.push(`second_tag=${encodeURIComponent(secondaryTag)}`);
        const queryString = queryParams.length > 0 ? `?${queryParams.join('&')}` : '';

        // 发起请求（带筛选参数）
        fetch(`${baseUrl}/getRandom10${queryString}`, { method: "GET" })
            .then(res => res.json())
            .then(res => {
                list.innerHTML = "";

                if (res.code !== 200) {
                    list.innerText = res.msg;
                    return;
                }

                const questions = res.data;
                if (questions.length === 0) {
                    list.innerText = "当前筛选条件下暂无题目，请更换分类或前往【题目上传】页面录入题目！";
                    return;
                }

                // 渲染题目列表（新增分类展示）
                questions.forEach((q, index) => {
                    const item = document.createElement("div");
                    item.className = "question-item";

                    // 题型转换
                    let typeText = "";
                    let typeColor = "";
                    switch (q.question_type) {
                        case 0:
                            typeText = "选择题";
                            typeColor = "#4285F4";
                            break;
                        case 1:
                            typeText = "填空题";
                            typeColor = "#28a745";
                            break;
                        case 2:
                            typeText = "问答题";
                            typeColor = "#ffc107";
                            break;
                        default:
                            typeText = "未知题型";
                            typeColor = "#6c757d";
                    }

                    // 拼接HTML（新增分类标签和收藏星形图标）
                    let html = `
                          <h4>
                              <span class="question-type" style="background-color: ${typeColor}">${typeText}</span>
                              ${index + 1}. ${q.question_title}
                              <span class="favorite-star" onclick="toggleFavorite(${q.id}, this, '${q.tag}', '${q.second_tag}')" id="favorite_${q.id}">★</span>
                          </h4>
                      `;

                    // 显示分类标签（有值才展示）
                    if (q.tag || q.second_tag) {
                        html += `<div style="margin: 8px 0;">`;
                        if (q.tag) {
                            html += `<span class="tag-label">一级分类：${q.tag}</span>`;
                        }
                        if (q.second_tag) {
                            html += `<span class="second-tag-label">二级分类：${q.second_tag}</span>`;
                        }
                        html += `</div>`;
                    }

                    // 选择题显示选项
                    if (q.question_type === 0) {
                        html += `
                              <p>A. ${q.option_a}</p>
                              <p>B. ${q.option_b}</p>
                              <p>C. ${q.option_c}</p>
                              <p>D. ${q.option_d}</p>
                          `;
                    }

                    // 答案、解析、备注
                    html += `
                          <p class="correct-answer">正确答案：${q.correct_answer}</p>
                          <p class="analysis">解析：${q.answer_analysis || "无解析"}</p>
                          <p class="remark">备注：${q.question_remark || "无备注"}</p>
                      `;

                    item.innerHTML = html;
                    list.appendChild(item);
                });

                // 获取收藏状态
                getCollectionStatus(questions);
            })
            .catch(err => {
                list.innerText = "获取题目失败：" + err.message;
            });
    }

    // 获取收藏状态
    function getCollectionStatus(questions) {
        if (questions.length === 0) return;

        // 提取题目ID列表
        const questionIDs = questions.map(q => q.id);

        // 构造查询参数
        const queryString = `?question_ids=${questionIDs.join('&question_ids=')}`;

        // 发起请求
        fetch(`${baseUrl}/collection/batch/status${queryString}`, { method: "GET" })
            .then(res => res.json())
            .then(res => {
                if (res.code === 200) {
                    const statusMap = res.data || {};

                    // 更新收藏状态
                    for (const questionID in statusMap) {
                        const starElement = document.getElementById(`favorite_${questionID}`);
                        if (starElement && statusMap[questionID]) {
                            starElement.classList.add('favorited');
                        }
                    }
                }
            })
            .catch(err => {
                console.error("获取收藏状态失败：", err);
            });
    }

    // 切换收藏状态
    function toggleFavorite(questionID, starElement, tag, secondTag) {
        const isFavorited = starElement.classList.contains('favorited');

        if (isFavorited) {
            // 取消收藏
            cancelFavorite(questionID, starElement);
        } else {
            // 添加收藏
            addFavorite(questionID, starElement, tag, secondTag);
        }
    }

    // 添加收藏
    function addFavorite(questionID, starElement, tag, secondTag) {
        // 构造请求数据
        const requestData = {
            question_id: questionID,
            tag: tag,
            second_tag: secondTag
        };

        // 发送请求
        fetch(`${baseUrl}/collection`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(requestData)
        })
        .then(res => res.json())
        .then(res => {
            if (res.code === 200) {
                starElement.classList.add('favorited');
            }
        })
        .catch(err => {
            console.error("收藏失败：", err);
        });
    }

    // 取消收藏
    function cancelFavorite(questionID, starElement) {
        // 发送请求
        fetch(`${baseUrl}/collection?question_id=${questionID}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        })
        .then(res => res.json())
        .then(res => {
            if (res.code === 200) {
                starElement.classList.remove('favorited');
            }
        })
        .catch(err => {
            console.error("取消收藏失败：", err);
        });
    }
</script>
</body>
</html>