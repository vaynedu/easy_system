<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>题目上传 - 简易多题型自动出题系统</title>
    <style>
        .container { width: 80%; margin: 20px auto; }
        .module { margin: 30px 0; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
        input, textarea, button, select, input[type="file"] {
            display: block; margin: 10px 0; padding: 8px; width: 50%; box-sizing: border-box;
        }
        button {
            background-color: #4285F4; color: white; border: none; border-radius: 4px; cursor: pointer;
        }
        button:hover { background-color: #3367D6; }
        .option-group { margin: 15px 0; }
        .tip { margin: 10px 0; }
        h1 { color: #333; border-bottom: 2px solid #4285F4; padding-bottom: 10px; }
        select {
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>题目上传（选择/填空/问答）</h1>

    <!-- 手动录入题目模块 -->
    <div class="module">
        <h2>手动录入题目</h2>
        <select id="questionType" onchange="toggleOptionGroup()">
            <option value="0">选择题</option>
            <option value="1">填空题</option>
            <option value="2">问答题</option>
        </select>
        <textarea id="questionTitle" placeholder="请输入题干内容" rows="3"></textarea>
        <div class="option-group" id="optionGroup">
            <input type="text" id="optionA" placeholder="选项A">
            <input type="text" id="optionB" placeholder="选项B">
            <input type="text" id="optionC" placeholder="选项C">
            <input type="text" id="optionD" placeholder="选项D">
        </div>
        <input type="text" id="correctAnswer" placeholder="正确答案（0=选择：A/B/C/D；1/2=填空/问答：具体答案）">
        <textarea id="answerAnalysis" placeholder="请输入答案解析（可选，问答题推荐填写）" rows="3"></textarea>
        <input type="text" id="questionRemark" placeholder="请输入题目备注（可选，如来源、难度等）">
        <!-- 一级Tag下拉选择 -->
        <select id="primaryTag" onchange="loadSecondaryTags()">
            <option value="">请选择一级分类（可选）</option>
        </select>
        <!-- 二级Tag下拉选择 -->
        <select id="secondaryTag">
            <option value="">请先选择一级分类</option>
        </select>
        <button onclick="addQuestion()">提交题目</button>
        <p id="addTip" class="tip"></p>
    </div>

    <!-- Excel批量导入模块 -->
    <div class="module">
        <h2>Excel批量导入题目</h2>
        <p style="color: #666;">Excel表头：题目类型、题干、选项A、选项B、选项C、选项D、正确答案、答案解析、题目备注、一级分类（tag）、二级分类（second_tag）</p>
        <p style="color: #666;">题型取值：0（选择题）、1（填空题）、2（问答题）；非选择题选项可留空；分类需与系统一致</p>
        <input type="file" id="excelFile" accept=".xlsx">
        <button onclick="importExcelQuestion()">上传并导入</button>
        <p id="importTip" class="tip"></p>
    </div>
</div>

<script>
    const baseUrl = "http://127.0.0.1:8080/api";
    let tagTreeData = []; // 存储从后端获取的完整Tag树数据

    // 页面加载时初始化
    window.onload = function() {
        toggleOptionGroup();
        loadPrimaryTags();
    }

    // 题型联动：显示/隐藏选项组
    function toggleOptionGroup() {
        const type = document.getElementById("questionType").value;
        const optionGroup = document.getElementById("optionGroup");
        optionGroup.style.display = type === "0" ? "block" : "none";
    }

    // 加载一级Tag数据（适配后端返回的字段名）
    function loadPrimaryTags() {
        const primaryTagSelect = document.getElementById("primaryTag");
        primaryTagSelect.innerHTML = '<option value="">请选择一级分类（可选）</option>';

        fetch(`${baseUrl}/tag/tree`, { method: "GET" })
            .then(res => res.json())
            .then(res => {
                if (res.code === 200) {
                    tagTreeData = res.data; // 缓存完整Tag树（后端返回结构：name + second_tag）
                    // 渲染一级Tag选项
                    tagTreeData.forEach(primaryTag => {
                        const option = document.createElement("option");
                        option.value = primaryTag.name;
                        option.textContent = primaryTag.name;
                        primaryTagSelect.appendChild(option);
                    });
                } else {
                    console.error("加载一级分类失败：", res.msg);
                    const tip = document.getElementById("addTip");
                    tip.style.color = "orange";
                    tip.innerText = "分类数据加载失败，请刷新页面重试！";
                }
            })
            .catch(err => {
                console.error("加载一级分类异常：", err);
                const tip = document.getElementById("addTip");
                tip.style.color = "orange";
                tip.innerText = "分类数据加载异常，请检查后端服务！";
            });
    }

    // 联动加载二级Tag数据（核心修复：字段名从secondary改为second_tag）
    function loadSecondaryTags() {
        const primaryTagValue = document.getElementById("primaryTag").value;
        const secondaryTagSelect = document.getElementById("secondaryTag");
        secondaryTagSelect.innerHTML = '';

        if (!primaryTagValue) {
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "请先选择一级分类";
            secondaryTagSelect.appendChild(defaultOption);
            return;
        }

        // 查找选中的一级分类（适配后端字段名second_tag）
        const targetPrimaryTag = tagTreeData.find(item => item.name === primaryTagValue);
        if (targetPrimaryTag && targetPrimaryTag.second_tag && targetPrimaryTag.second_tag.length > 0) {
            // 添加默认选项
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "请选择二级分类";
            secondaryTagSelect.appendChild(defaultOption);
            // 渲染二级Tag选项（遍历second_tag数组）
            targetPrimaryTag.second_tag.forEach(secondaryTag => {
                const option = document.createElement("option");
                option.value = secondaryTag;
                option.textContent = secondaryTag;
                secondaryTagSelect.appendChild(option);
            });
        } else {
            const noOption = document.createElement("option");
            noOption.value = "";
            noOption.textContent = "该一级分类无二级分类";
            secondaryTagSelect.appendChild(noOption);
        }
    }

    // 手动新增题目（适配Tag字段）
    function addQuestion() {
        const data = {
            question_type: parseInt(document.getElementById("questionType").value),
            question_title: document.getElementById("questionTitle").value.trim(),
            option_a: document.getElementById("optionA").value.trim(),
            option_b: document.getElementById("optionB").value.trim(),
            option_c: document.getElementById("optionC").value.trim(),
            option_d: document.getElementById("optionD").value.trim(),
            correct_answer: document.getElementById("correctAnswer").value.trim().toUpperCase(),
            answer_analysis: document.getElementById("answerAnalysis").value.trim(),
            question_remark: document.getElementById("questionRemark").value.trim(),
            tag: document.getElementById("primaryTag").value.trim(),
            second_tag: document.getElementById("secondaryTag").value.trim()
        };

        fetch(`${baseUrl}/addQuestion`, {
            method: "POST",
            headers: { "Content-Type": "application/json;charset=utf-8" },
            body: JSON.stringify(data)
        }).then(res => res.json())
            .then(res => {
                const tip = document.getElementById("addTip");
                tip.style.color = res.code === 200 ? "green" : "red";
                tip.innerText = res.msg;
                if (res.code === 200) {
                    // 清空所有输入框和下拉框
                    document.getElementById("questionType").value = "0";
                    document.getElementById("questionTitle").value = "";
                    document.getElementById("optionA").value = "";
                    document.getElementById("optionB").value = "";
                    document.getElementById("optionC").value = "";
                    document.getElementById("optionD").value = "";
                    document.getElementById("correctAnswer").value = "";
                    document.getElementById("answerAnalysis").value = "";
                    document.getElementById("questionRemark").value = "";
                    document.getElementById("primaryTag").value = "";
                    document.getElementById("secondaryTag").innerHTML = '<option value="">请先选择一级分类</option>';
                    toggleOptionGroup();
                }
            })
            .catch(err => {
                document.getElementById("addTip").style.color = "red";
                document.getElementById("addTip").innerText = "提交失败：" + err.message;
            });
    }

    // Excel批量导入
    function importExcelQuestion() {
        const fileInput = document.getElementById("excelFile");
        const file = fileInput.files[0];
        const tip = document.getElementById("importTip");

        if (!file) {
            tip.style.color = "red";
            tip.innerText = "请先选择Excel文件！";
            return;
        }

        const formData = new FormData();
        formData.append("excelFile", file);

        tip.style.color = "#333";
        tip.innerText = "正在导入，请稍候...";

        fetch(`${baseUrl}/importExcelQuestion`, {
            method: "POST",
            body: formData
        }).then(res => res.json())
            .then(res => {
                tip.style.color = res.code === 200 ? "green" : "red";
                tip.innerText = res.msg;
                fileInput.value = "";
            })
            .catch(err => {
                tip.style.color = "red";
                tip.innerText = "导入失败：" + err.message;
                fileInput.value = "";
            });
    }
</script>
</body>
</html>