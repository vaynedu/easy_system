<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>收藏题目 - 简易多题型自动出题系统</title>
    <style>
        .container { width: 90%; margin: 20px auto; }
        .module { margin: 30px 0; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
        button {
            padding: 8px 15px; margin: 5px;
            background-color: #4285F4; color: white; border: none; border-radius: 4px; cursor: pointer;
        }
        button:hover { background-color: #3367D6; }
        select, input {
            padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f5f5f5; }
        .pagination { margin-top: 20px; text-align: center; }
        .pagination button { margin: 0 5px; }
        .question-item {
            margin: 20px 0; padding: 15px; border: 1px solid #eee; border-radius: 6px;
            background-color: #f9f9f9;
        }
        .question-type {
            display: inline-block; padding: 2px 8px; margin-right: 10px;
            background-color: #4285F4; color: white; border-radius: 4px; font-size: 12px;
        }
        .tag-label {
            display: inline-block; padding: 2px 8px; margin: 2px;
            background-color: #6c757d; color: white; border-radius: 4px; font-size: 12px;
        }
        .second-tag-label {
            display: inline-block; padding: 2px 8px; margin: 2px;
            background-color: #17a2b8; color: white; border-radius: 4px; font-size: 12px;
        }
        .correct-answer { color: #28a745; font-weight: bold; }
        .analysis { color: #666; margin: 5px 0; }
        .remark { color: #999; font-style: italic; font-size: 14px; }
        h1 { color: #333; border-bottom: 2px solid #4285F4; padding-bottom: 10px; }
        .collection-section {
            display: inline-block; margin-right: 20px; margin-bottom: 10px;
        }
        .collection-label {
            font-weight: bold; margin-right: 10px;
        }
        .collection-count {
            color: #4285F4;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>收藏题目</h1>

    <!-- 收藏题目分类筛选 -->
    <div class="module">
        <h2>收藏分类筛选</h2>
        <div class="collection-section">
            <label class="collection-label">一级分类：</label>
            <select id="primaryTag" onchange="loadSecondaryTags()">
                <option value="">请选择一级分类（可选）</option>
                <!-- 动态加载一级分类 -->
            </select>
        </div>
        <div class="collection-section">
            <label class="collection-label">二级分类：</label>
            <select id="secondaryTag">
                <option value="">请先选择一级分类</option>
                <!-- 联动加载二级分类 -->
            </select>
        </div>
        <div class="collection-section">
            <button onclick="getCollectionList()">筛选收藏</button>
            <button onclick="resetFilter()">重置筛选</button>
        </div>
    </div>

    <!-- 收藏题目列表展示 -->
    <div class="module">
        <h2>收藏题目列表</h2>
        <div id="collectionStats" style="margin-bottom: 15px;">
            <!-- 收藏统计信息 -->
        </div>
        <div id="collectionList"></div>
        <div class="pagination" id="pagination">
            <!-- 分页按钮 -->
        </div>
    </div>
</div>

<script>
    const baseUrl = "http://127.0.0.1:8080/api";
    let tagTreeData = []; // 缓存分类树数据
    let currentPage = 1;
    const pageSize = 10;
    let totalCollections = 0;

    // 页面加载初始化
    window.onload = function() {
        loadPrimaryTags();
        getCollectionList();
    }

    // 加载一级分类数据
    function loadPrimaryTags() {
        const primaryTagSelect = document.getElementById("primaryTag");
        primaryTagSelect.innerHTML = '<option value="">请选择一级分类（可选）</option>';

        fetch(`${baseUrl}/tag/tree`, { method: "GET" })
            .then(res => res.json())
            .then(res => {
                if (res.code === 200) {
                    tagTreeData = res.data;
                    // 渲染一级分类选项
                    tagTreeData.forEach(primaryTag => {
                        const option = document.createElement("option");
                        option.value = primaryTag.name;
                        option.textContent = primaryTag.name;
                        primaryTagSelect.appendChild(option);
                    });
                } else {
                    console.error("加载分类数据失败：", res.msg);
                    const list = document.getElementById("collectionList");
                    list.style.color = "orange";
                    list.innerText = "分类数据加载失败！";
                }
            })
            .catch(err => {
                console.error("加载分类异常：", err);
                const list = document.getElementById("collectionList");
                list.style.color = "orange";
                list.innerText = "分类数据加载异常！";
            });
    }

    // 联动加载二级分类数据
    function loadSecondaryTags() {
        const primaryTagValue = document.getElementById("primaryTag").value;
        const secondaryTagSelect = document.getElementById("secondaryTag");
        secondaryTagSelect.innerHTML = '';

        if (!primaryTagValue) {
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "请先选择一级分类";
            secondaryTagSelect.appendChild(defaultOption);
            return;
        }

        const targetPrimaryTag = tagTreeData.find(item => item.name === primaryTagValue);
        if (targetPrimaryTag && targetPrimaryTag.second_tag && targetPrimaryTag.second_tag.length > 0) {
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "请选择二级分类（可选）";
            secondaryTagSelect.appendChild(defaultOption);
            // 渲染二级分类选项
            targetPrimaryTag.second_tag.forEach(secondaryTag => {
                const option = document.createElement("option");
                option.value = secondaryTag;
                option.textContent = secondaryTag;
                secondaryTagSelect.appendChild(option);
            });
        } else {
            const noOption = document.createElement("option");
            noOption.value = "";
            noOption.textContent = "该一级分类无二级分类";
            secondaryTagSelect.appendChild(noOption);
        }
    }

    // 获取收藏列表
    function getCollectionList() {
        currentPage = 1;
        loadCollectionList();
    }

    // 加载收藏列表（分页）
    function loadCollectionList() {
        const list = document.getElementById("collectionList");
        list.innerHTML = '<p style="color: #666;">正在获取收藏题目，请稍候...</p>';

        // 获取筛选条件
        const primaryTag = document.getElementById("primaryTag").value.trim();
        const secondaryTag = document.getElementById("secondaryTag").value.trim();

        // 构造查询参数
        let queryParams = [];
        if (primaryTag) queryParams.push(`tag=${encodeURIComponent(primaryTag)}`);
        if (secondaryTag) queryParams.push(`second_tag=${encodeURIComponent(secondaryTag)}`);
        queryParams.push(`page=${currentPage}`);
        queryParams.push(`size=${pageSize}`);
        const queryString = queryParams.length > 0 ? `?${queryParams.join('&')}` : '?page=1&size=10';

        // 发起请求（带筛选参数和分页）
        fetch(`${baseUrl}/collections${queryString}`, { method: "GET" })
            .then(res => res.json())
            .then(res => {
                list.innerHTML = "";

                if (res.code !== 200) {
                    list.innerText = res.msg;
                    return;
                }

                const collections = res.data.collections || [];
                totalCollections = res.data.total || 0;

                // 更新统计信息
                updateCollectionStats(totalCollections);

                if (collections.length === 0) {
                    list.innerText = "暂无收藏题目，请前往其他页面收藏题目！";
                    document.getElementById("pagination").innerHTML = "";
                    return;
                }

                // 渲染收藏题目列表
                collections.forEach((collection, index) => {
                    const question = collection.question;
                    if (!question) return;

                    const item = document.createElement("div");
                    item.className = "question-item";

                    // 题型转换
                    let typeText = "";
                    let typeColor = "";
                    switch (question.question_type) {
                        case 0:
                            typeText = "选择题";
                            typeColor = "#4285F4";
                            break;
                        case 1:
                            typeText = "填空题";
                            typeColor = "#28a745";
                            break;
                        case 2:
                            typeText = "问答题";
                            typeColor = "#ffc107";
                            break;
                        default:
                            typeText = "未知题型";
                            typeColor = "#6c757d";
                    }

                    // 拼接HTML
                    let html = `
                        <h4>
                            <span class="question-type" style="background-color: ${typeColor}">${typeText}</span>
                            ${(currentPage - 1) * pageSize + index + 1}. ${question.question_title}
                        </h4>
                    `;

                    // 显示分类标签（有值才展示）
                    if (question.tag || question.second_tag) {
                        html += `<div style="margin: 8px 0;">`;
                        if (question.tag) {
                            html += `<span class="tag-label">一级分类：${question.tag}</span>`;
                        }
                        if (question.second_tag) {
                            html += `<span class="second-tag-label">二级分类：${question.second_tag}</span>`;
                        }
                        html += `</div>`;
                    }

                    // 选择题显示选项
                    if (question.question_type === 0) {
                        html += `
                            <p>A. ${question.option_a}</p>
                            <p>B. ${question.option_b}</p>
                            <p>C. ${question.option_c}</p>
                            <p>D. ${question.option_d}</p>
                        `;
                    }

                    // 答案、解析、备注
                    html += `
                        <p class="correct-answer">正确答案：${question.correct_answer}</p>
                        <p class="analysis">解析：${question.answer_analysis || "无解析"}</p>
                        <p class="remark">备注：${question.question_remark || "无备注"}</p>
                        <div style="margin-top: 10px;">
                            <button onclick="cancelCollection(${question.id})" style="background-color: #dc3545;">取消收藏</button>
                            <span style="color: #666; margin-left: 10px;">收藏时间：${new Date(collection.created_at).toLocaleString()}</span>
                        </div>
                    `;

                    item.innerHTML = html;
                    list.appendChild(item);
                });

                // 渲染分页
                renderPagination(totalCollections, currentPage, pageSize);
            })
            .catch(err => {
                list.innerText = "获取收藏题目失败：" + err.message;
            });
    }

    // 更新收藏统计信息
    function updateCollectionStats(total) {
        const statsDiv = document.getElementById("collectionStats");
        statsDiv.innerHTML = `<strong>共收藏 ${total} 道题目</strong>`;
    }

    // 取消收藏
    function cancelCollection(questionID) {
        if (!confirm("确定要取消收藏这道题目吗？")) {
            return;
        }

        // 发送取消收藏请求
        fetch(`${baseUrl}/collection?question_id=${questionID}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        })
        .then(res => res.json())
        .then(res => {
            if (res.code === 200) {
                alert("取消收藏成功");
                loadCollectionList(); // 刷新列表
            } else {
                alert("取消收藏失败：" + res.msg);
            }
        })
        .catch(err => {
            alert("取消收藏失败：" + err.message);
        });
    }

    // 渲染分页
    function renderPagination(total, currentPage, pageSize) {
        const totalPages = Math.ceil(total / pageSize);
        const pagination = document.getElementById("pagination");

        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }

        let html = '';
        if (currentPage > 1) {
            html += `<button onclick="goToPage(${currentPage - 1})">上一页</button>`;
        }

        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage) {
                html += `<button style="background-color: #007bff; color: white;">${i}</button>`;
            } else {
                html += `<button onclick="goToPage(${i})">${i}</button>`;
            }
        }

        if (currentPage < totalPages) {
            html += `<button onclick="goToPage(${currentPage + 1})">下一页</button>`;
        }

        pagination.innerHTML = html;
    }

    // 跳转到指定页
    function goToPage(page) {
        currentPage = page;
        loadCollectionList();
    }

    // 重置筛选条件
    function resetFilter() {
        document.getElementById("primaryTag").value = "";
        document.getElementById("secondaryTag").innerHTML = '<option value="">请先选择一级分类</option>';
        getCollectionList();
    }
</script>
</body>
</html>