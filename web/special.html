<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>专项练习 - 简易多题型自动出题系统</title>
    <style>
        .container { width: 90%; margin: 20px auto; }
        .module { margin: 30px 0; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
        button {
            padding: 8px 15px; margin: 5px;
            background-color: #4285F4; color: white; border: none; border-radius: 4px; cursor: pointer;
        }
        button:hover { background-color: #3367D6; }
        select, input {
            padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f5f5f5; }
        .pagination { margin-top: 20px; text-align: center; }
        .pagination button { margin: 0 5px; }
        .question-item {
            margin: 20px 0; padding: 15px; border: 1px solid #eee; border-radius: 6px;
            background-color: #f9f9f9;
        }
        .question-type {
            display: inline-block; padding: 2px 8px; margin-right: 10px;
            background-color: #4285F4; color: white; border-radius: 4px; font-size: 12px;
        }
        .tag-label {
            display: inline-block; padding: 2px 8px; margin: 2px;
            background-color: #6c757d; color: white; border-radius: 4px; font-size: 12px;
        }
        .second-tag-label {
            display: inline-block; padding: 2px 8px; margin: 2px;
            background-color: #17a2b8; color: white; border-radius: 4px; font-size: 12px;
        }
        .correct-answer { color: #28a745; font-weight: bold; white-space: pre-line;}
        .analysis { color: #666; margin: 5px 0; }
        .remark { color: #999; font-style: italic; font-size: 14px; }
        h1 { color: #333; border-bottom: 2px solid #4285F4; padding-bottom: 10px; }
    </style>
</head>
<body>
<div class="container">
    <h1>专项练习</h1>

    <!-- 专项分类筛选模块 -->
    <div class="module">
        <h2>专项分类筛选</h2>
        <select id="primaryTag" onchange="loadSecondaryTags()">
            <option value="">请选择一级分类（可选）</option>
            <!-- 动态加载一级分类 -->
        </select>
        <select id="secondaryTag">
            <option value="">请先选择一级分类</option>
            <!-- 联动加载二级分类 -->
        </select>
        <button onclick="getSpecialQuestions()">获取专项题目</button>
    </div>

    <!-- 题目列表展示 -->
    <div class="module">
        <h2>专项题目列表</h2>
        <div id="questionList"></div>
        <div class="pagination" id="pagination">
            <!-- 分页按钮 -->
        </div>
    </div>
</div>

<script>
    const baseUrl = "http://127.0.0.1:8080/api";
    let tagTreeData = []; // 缓存分类树数据
    let currentPage = 1;
    const pageSize = 10;

    // 页面加载初始化
    window.onload = function() {
        loadPrimaryTags();
    }

    // 加载一级分类数据
    function loadPrimaryTags() {
        const primaryTagSelect = document.getElementById("primaryTag");
        primaryTagSelect.innerHTML = '<option value="">请选择一级分类（可选）</option>';

        fetch(`${baseUrl}/tag/tree`, { method: "GET" })
            .then(res => res.json())
            .then(res => {
                if (res.code === 200) {
                    tagTreeData = res.data;
                    // 渲染一级分类选项
                    tagTreeData.forEach(primaryTag => {
                        const option = document.createElement("option");
                        option.value = primaryTag.name;
                        option.textContent = primaryTag.name;
                        primaryTagSelect.appendChild(option);
                    });
                } else {
                    console.error("加载分类数据失败：", res.msg);
                    const list = document.getElementById("questionList");
                    list.style.color = "orange";
                    list.innerText = "分类数据加载失败！";
                }
            })
            .catch(err => {
                console.error("加载分类异常：", err);
                const list = document.getElementById("questionList");
                list.style.color = "orange";
                list.innerText = "分类数据加载异常！";
            });
    }

    // 联动加载二级分类数据
    function loadSecondaryTags() {
        const primaryTagValue = document.getElementById("primaryTag").value;
        const secondaryTagSelect = document.getElementById("secondaryTag");
        secondaryTagSelect.innerHTML = '';

        if (!primaryTagValue) {
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "请先选择一级分类";
            secondaryTagSelect.appendChild(defaultOption);
            return;
        }

        const targetPrimaryTag = tagTreeData.find(item => item.name === primaryTagValue);
        if (targetPrimaryTag && targetPrimaryTag.second_tag && targetPrimaryTag.second_tag.length > 0) {
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "请选择二级分类（可选）";
            secondaryTagSelect.appendChild(defaultOption);
            // 渲染二级分类选项
            targetPrimaryTag.second_tag.forEach(secondaryTag => {
                const option = document.createElement("option");
                option.value = secondaryTag;
                option.textContent = secondaryTag;
                secondaryTagSelect.appendChild(option);
            });
        } else {
            const noOption = document.createElement("option");
            noOption.value = "";
            noOption.textContent = "该一级分类无二级分类";
            secondaryTagSelect.appendChild(noOption);
        }
    }

    // 获取专项题目
    function getSpecialQuestions() {
        currentPage = 1;
        loadSpecialQuestions();
    }

    // 加载专项题目（分页）
    function loadSpecialQuestions() {
        const list = document.getElementById("questionList");
        list.innerHTML = '<p style="color: #666;">正在获取题目，请稍候...</p>';

        // 获取筛选条件
        const primaryTag = document.getElementById("primaryTag").value.trim();
        const secondaryTag = document.getElementById("secondaryTag").value.trim();

        // 构造查询参数
        let queryParams = [];
        if (primaryTag) queryParams.push(`tag=${encodeURIComponent(primaryTag)}`);
        if (secondaryTag) queryParams.push(`second_tag=${encodeURIComponent(secondaryTag)}`);
        queryParams.push(`page=${currentPage}`);
        queryParams.push(`size=${pageSize}`);
        const queryString = queryParams.length > 0 ? `?${queryParams.join('&')}` : '?page=1&size=10';

        // 发起请求（带筛选参数和分页）
        fetch(`${baseUrl}/questions${queryString}`, { method: "GET" })
            .then(res => res.json())
            .then(res => {
                list.innerHTML = "";

                if (res.code !== 200) {
                    list.innerText = res.msg;
                    return;
                }

                const questions = res.data.questions;
                const total = res.data.total;

                if (questions.length === 0) {
                    list.innerText = "当前筛选条件下暂无题目，请更换分类或前往【题目上传】页面录入题目！";
                    document.getElementById("pagination").innerHTML = "";
                    return;
                }

                // 渲染题目列表
                questions.forEach((q, index) => {
                    const item = document.createElement("div");
                    item.className = "question-item";

                    // 题型转换
                    let typeText = "";
                    let typeColor = "";
                    switch (q.question_type) {
                        case 0:
                            typeText = "选择题";
                            typeColor = "#4285F4";
                            break;
                        case 1:
                            typeText = "填空题";
                            typeColor = "#28a745";
                            break;
                        case 2:
                            typeText = "问答题";
                            typeColor = "#ffc107";
                            break;
                        default:
                            typeText = "未知题型";
                            typeColor = "#6c757d";
                    }

                    // 拼接HTML
                    let html = `
                        <h4>
                            <span class="question-type" style="background-color: ${typeColor}">${typeText}</span>
                            ${index + 1}. ${q.question_title}
                        </h4>
                    `;

                    // 显示分类标签（有值才展示）
                    if (q.tag || q.second_tag) {
                        html += `<div style="margin: 8px 0;">`;
                        if (q.tag) {
                            html += `<span class="tag-label">一级分类：${q.tag}</span>`;
                        }
                        if (q.second_tag) {
                            html += `<span class="second-tag-label">二级分类：${q.second_tag}</span>`;
                        }
                        html += `</div>`;
                    }

                    // 选择题显示选项
                    if (q.question_type === 0) {
                        html += `
                            <p>A. ${q.option_a}</p>
                            <p>B. ${q.option_b}</p>
                            <p>C. ${q.option_c}</p>
                            <p>D. ${q.option_d}</p>
                        `;
                    }

                    // 答案、解析、备注
                    html += `
                        <p class="correct-answer">正确答案：${q.correct_answer}</p>
                        <p class="analysis">解析：${q.answer_analysis || "无解析"}</p>
                        <p class="remark">备注：${q.question_remark || "无备注"}</p>
                    `;

                    item.innerHTML = html;
                    list.appendChild(item);
                });

                // 渲染分页
                renderPagination(total, currentPage, pageSize);
            })
            .catch(err => {
                list.innerText = "获取题目失败：" + err.message;
            });
    }

    // 渲染分页
    function renderPagination(total, currentPage, pageSize) {
        const totalPages = Math.ceil(total / pageSize);
        const pagination = document.getElementById("pagination");

        let html = '';
        if (currentPage > 1) {
            html += `<button onclick="goToPage(${currentPage - 1})">上一页</button>`;
        }

        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage) {
                html += `<button style="background-color: #007bff; color: white;">${i}</button>`;
            } else {
                html += `<button onclick="goToPage(${i})">${i}</button>`;
            }
        }

        if (currentPage < totalPages) {
            html += `<button onclick="goToPage(${currentPage + 1})">下一页</button>`;
        }

        pagination.innerHTML = html;
    }

    // 跳转到指定页
    function goToPage(page) {
        currentPage = page;
        loadSpecialQuestions();
    }
</script>
</body>
</html>
